# WARNING: This file is autogenerated - changes will be overwritten when regenerated by https://github.com/pulumi/ci-mgmt

name: Upgrade bridge
on:
  repository_dispatch:
    types:
      - upgrade-bridge
      - upgrade-bridge-test
  workflow_dispatch:
    inputs:
      kind:
        description: Overrides the kind of upgrade. Must be one of `all`, `bridge`, `provider`, `code`, `pf`, or `pulumi`.
        required: false
        type: choice
        default: "bridge"
        options:
          - all
          - bridge
          - provider
          - code
          - pf
          - pulumi
      target-bridge-version:
        description: pulumi-terraform-bridge version or hash reference
        required: false
        type: string
        default: "latest"
      target-pulumi-version:
        description: |
             Set the version of `pulumi/pkg` and `pulumi/sdk` to depend on for bridged providers. Currently,
             these versions inform the linked runtime and SDK generation in all languages except Java. Valid
             options are:
             - "": Use the same version as pulumi-terraform-bridge
             - A go version such as "v3.90.1"
             - A commit SHA in pulumi/pulumi such as "ac71ebc1d34e5ccfd1a7fed61e6ff43a3160f3cb"
        required: false
        type: string
        default: ""
      automerge:
        description: Mark created PR for auto-merging?
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  GH_TOKEN: ${{ secrets.PULUMI_PROVIDER_AUTOMATION_TOKEN || secrets.PULUMI_BOT_TOKEN || secrets.GITHUB_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
  NUGET_PUBLISH_KEY: ${{ secrets.NUGET_PUBLISH_KEY }}
  PUBLISH_REPO_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
  PUBLISH_REPO_USERNAME: ${{ secrets.OSSRH_USERNAME }}
  PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
  PULUMI_API: https://api.pulumi-staging.io
  PULUMI_GO_DEP_ROOT: ${{ github.workspace }}/..
  PULUMI_LOCAL_NUGET: ${{ github.workspace }}/nuget
  PYPI_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
  PYPI_USERNAME: __token__
  SIGNING_KEY: ${{ secrets.JAVA_SIGNING_KEY }}
  SIGNING_KEY_ID: ${{ secrets.JAVA_SIGNING_KEY_ID }}
  SIGNING_PASSWORD: ${{ secrets.JAVA_SIGNING_PASSWORD }}
  TF_APPEND_USER_AGENT: pulumi

jobs:
  upgrade_provider:
    name: upgrade-provider
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repo
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        persist-credentials: false
        submodules: true
    - name: Setup tools
      uses: ./.github/actions/setup-tools
      with:
        tools: pulumictl, pulumicli, dotnet, go, nodejs, python
    - name: Format validation - target_bridge_version
      # Run this step only when the current TASK cares about the bridge version
      if: github.event_name == 'repository_dispatch'
      env:
        TARGET_BRIDGE_VERSION: ${{ inputs.target-bridge-version }}   # adapt if you export it differently
      run: |
        # Allowed: the literal string “latest”, a semver tag (e.g. v2.49.0[-rc.1]),
        # or a 40-char git SHA.
        [[ "$TARGET_BRIDGE_VERSION" == "latest" ]] && exit 0
        [[ "$TARGET_BRIDGE_VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[A-Za-z0-9.\-]+)?$ ]] && exit 0
        [[ "$TARGET_BRIDGE_VERSION" =~ ^[0-9a-f]{40}$ ]] && exit 0

        echo "❌ target-bridge-version must be 'latest', a semver (vX.Y.Z), or a 40-char SHA" >&2
        exit 1    
    - name: Format validation - target_pulumi_version
      # Run this step only when the current TASK cares about the pulumi version
      if: github.event_name == 'repository_dispatch'
      env:
        TARGET_PULUMI_VERSION: ${{ inputs.target-pulumi-version }}   # adapt if you export it differently
      run: |
        # Allowed: empty string "", a semver tag (e.g. v3.90.1[-rc.2]), or a 40-char git SHA.
        [[ -z "$TARGET_PULUMI_VERSION" ]] && exit 0
        [[ "$TARGET_PULUMI_VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[A-Za-z0-9.\-]+)?$ ]] && exit 0
        [[ "$TARGET_PULUMI_VERSION" =~ ^[0-9a-f]{40}$ ]] && exit 0

        echo "❌ target-pulumi-version must be empty, a semver (vX.Y.Z), or a 40-char SHA" >&2
        exit 1
    - name: Call upgrade provider action
      if: github.event_name == 'workflow_dispatch'
      uses: pulumi/pulumi-upgrade-provider-action@ff5cb5907aecba099e61146c4d4d074c7fd6ca99 # v0.0.15
      with:
        kind: ${{ inputs.kind }}
        email: bot@pulumi.com
        username: pulumi-bot
        automerge: ${{ inputs.automerge }}
        target-bridge-version: ${{ inputs.target-bridge-version }}
        target-pulumi-version: ${{ inputs.target-pulumi-version }}
    - name: Call upgrade provider action
      if: github.event_name == 'repository_dispatch'
      uses: pulumi/pulumi-upgrade-provider-action@ff5cb5907aecba099e61146c4d4d074c7fd6ca99 # v0.0.15
      with:
        kind: ${{ github.event.client_payload.kind || 'bridge' }}
        email: bot@pulumi.com
        username: pulumi-bot
        automerge: ${{ github.event.client_payload.automerge }}
        target-pulumi-version: ${{ github.event.client_payload.target-pulumi-version }}
        target-bridge-version: ${{ github.event.client_payload.target-bridge-version }}
        pr-reviewers: ${{ github.event.client_payload.pr-reviewers }}
        pr-description: ${{ github.event.client_payload.pr-description }}
        pr-title-prefix: ${{ github.event.client_payload.pr-title-prefix }}
